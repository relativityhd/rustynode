<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>
  <body>
    <main>
      <h1>Benchmarks: </h1>
      <div id="plot-wrapper">
        <div id="plot-pi_opt"></div><hr>
        <div id="plot-pi"></div><hr>
        <div id="plot-fib_opt"></div><hr>
        <div id="plot-fib"></div><hr>
        <div id="plot-fib_it"></div>
      </div>
    </main>
  </body>
  <script>
    window.onload = () => {
      requestData('Pi-Optimized', (benches) => {
        renderPlot('plot-pi_opt', benches, 'Benchmarks of an <b>optimized</b> (removed if statements) Pi calculation with the Gregory-Leibniz Series')
      })

      requestData('Pi', (benches) => {
        renderPlot('plot-pi', benches, 'Benchmarks of a Pi calculation with the Gregory-Leibniz Series')
      })

      requestData('Fibonacci-Optimized', (benches) => {
        renderPlot('plot-fib_opt', benches, 'Benchmarks of the <b>optimized</b> calculation of the n-th Fibonacci number based on based Dijkstra\'s method')
      })
      
      requestData('Fibonacci', (benches) => {
        renderPlot('plot-fib', benches, 'Benchmarks of the calculation of the n-th Fibonacci number')
      })

      requestData('Fibonacci-Iterative', (benches) => {
        renderPlot('plot-fib_it', benches, 'Benchmarks of the <b>iterative</b> calculation of the n-th Fibonacci number')
      })
    }

    function requestData(bname, onJson) {
      const xhr = new XMLHttpRequest()
      xhr.onload = () => {
        console.log(xhr)
        if (xhr.status !== 200) return
        console.log(JSON.parse(xhr.response))
        onJson(JSON.parse(xhr.response))
      }
      xhr.open('GET', `/bench?benchid=${bname}`, true);
      xhr.send('')
    }

    function renderPlot(divid, benches, bname) {
      const data = []
      const layout = {
        barmode: 'group',
        yaxis: {
          type: 'log',
          autorange: true,
          ticksuffix: 's',
          title: 'Execution Time'
        },
        title: {
          text: bname,
          xref: 'paper',
          x: 0,
        },
        colorway : ['#9ef0f0', '#3ddbd9', '#08bdba', '#009d9a']
      }
      const modules = benches.map(e => e.module).filter((m, i, s) => s.indexOf(m) === i)
      for (let module of modules) {
        data.push({
          x: benches.filter(e => e.module === module).map(e => `n: ${e.args}`),
          y: benches.filter(e => e.module === module).map(e => e.mean),
          error_y: {
            type: 'data',
            array: benches.filter(e => e.module === module).map(e => e.moe),
            visible: true
          },
          name: module,
          type: 'bar',
          log_y: true,
          text: benches.filter(e => e.module === module).map(e => e.mean.toExponential(2)),
          textposition: 'auto'
        })
      }
      console.log(data)
      Plotly.newPlot(divid, data, layout, {responsive: true})
    }
  </script>
</html>
